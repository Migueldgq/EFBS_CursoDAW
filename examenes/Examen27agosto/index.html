<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  </head>
  <body class="bg-sky-900">
    <header class="flex justify-center items-center pt-10">
      <h1 class="text-3xl text-white">Creador de facturas</h1>
      <button
        id="verFacturasBut"
        class="ml-10 font-medium text-blue-500 hover:underline"
      >
        Ver facturas
      </button>
    </header>
    <main>
      <section
        id="addProduct"
        class="hidden flex-col gap-5 max-w-sm mx-auto pt-10"
      >
        <article>
          <label class="block mb-2 text-md font-medium text-white" for="nomProd"
            >Nombre del producto</label
          >
          <input
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
            type="text"
            id="nomProd"
            name="nomProd"
          />
        </article>
        <article>
          <label
            class="block mb-2 text-md font-medium text-white"
            for="precioProd"
            >Precio del producto</label
          >
          <input
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
            type="number"
            id="precioProd"
            name="precioProd"
          />
        </article>
        <article>
          <label
            for="quantity-input"
            class="block mb-2 text-sm font-medium text-white"
            >Elige la cantidad:</label
          >
          <div class="relative flex items-center max-w-[8rem]">
            <button
              type="button"
              id="decrement-button"
              data-input-counter-decrement="quantity-input"
              class="bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-s-lg p-3 h-11 focus:ring-gray-100 focus:ring-2 focus:outline-none"
            >
              <svg
                class="w-3 h-3 text-gray-900"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 18 2"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M1 1h16"
                />
              </svg>
            </button>
            <input
              type="text"
              id="cantidad"
              name="cantidad"
              data-input-counter
              aria-describedby="helper-text-explanation"
              class="bg-gray-50 border-x-0 border-gray-300 h-11 text-center text-gray-900 text-sm focus:ring-blue-500 focus:border-blue-500 block w-full py-2.5"
              placeholder="999"
              required
            />
            <button
              type="button"
              id="increment-button"
              data-input-counter-increment="quantity-input"
              class="bg-gray-100 hover:bg-gray-200 border border-gray-300 rounded-e-lg p-3 h-11 focus:ring-gray-100 focus:ring-2 focus:outline-none"
            >
              <svg
                class="w-3 h-3 text-gray-900"
                aria-hidden="true"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 18 18"
              >
                <path
                  stroke="currentColor"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 1v16M1 9h16"
                />
              </svg>
            </button>
          </div>
        </article>
        <article>
          <button
            id="addProductBut"
            class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full"
          >
            Añadir Producto
          </button>
        </article>
      </section>

      <section
        id="CreateFactura"
        class="flex justify-center items-center pt-10"
      >
        <button
          id="createFacturaBut"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full"
        >
          Crear nueva factura
        </button>
      </section>

      <section id="verfacts" class="hidden">
        <table
          class="w-full text-sm text-left mt-10 rtl:text-right text-gray-500 dark:text-gray-400"
        >
          <thead
            class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
          >
            <tr>
              <th scope="col" class="px-6 py-3">Factura ID</th>
              <th scope="col" class="px-6 py-3">Fecha</th>
              <th scope="col" class="px-6 py-3">
                <span class="sr-only">ver</span>
              </th>
            </tr>
          </thead>
          <tbody id="verfactsbody"></tbody>
        </table>
      </section>

      <section id="verfactsdetails" class="hidden">
        <table
          class="w-full text-sm text-left mt-10 rtl:text-right text-gray-500 dark:text-gray-400"
        >
          <thead
            class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400"
          >
            <tr>
              <th scope="col" class="px-6 py-3">Producto</th>
              <th scope="col" class="px-6 py-3">Precio</th>
              <th scope="col" class="px-6 py-3">Cantidad</th>
              <th scope="col" class="px-6 py-3">Total</th>
            </tr>
          </thead>
          <tbody id="verfactsdetailsbody"></tbody>
          <tfoot id="verfactsdetailsfoot"></tfoot id="verfactsdetailsfoot">
        </table>
      </section>
    </main>

    <script>
      let facturaId = "";
      $("#cantidad").val(1);

      $("#decrement-button").click(function () {
        let cantidadActual = parseInt($("#cantidad").val(), 10);
        if (cantidadActual > 1) {
          $("#cantidad").val(cantidadActual - 1);
        }
      });

      $("#increment-button").click(function () {
        let cantidadActual = parseInt($("#cantidad").val(), 10);
        $("#cantidad").val(cantidadActual + 1);
      });

      $("#createFacturaBut").click(function () {
        $.post("createFactura.php", {}, function (data) {
          let response = JSON.parse(data);
          facturaId = response.factId;
          //console.log(response.success);

          if (response.success === true) {
            $("#CreateFactura").addClass("hidden");
            $("#addProduct").addClass("flex");
            $("#addProduct").removeClass("hidden");
          } else {
            console.log("Fallando");
          }
        });
      });

      $("#addProductBut").click(function () {
        let nomProd = $("#nomProd").val();
        let precioProd = $("#precioProd").val();
        let cantidad = $("#cantidad").val();
        let precioFinal = parseInt(precioProd) * parseInt(cantidad);

        console.log(
          `Factura ID: ${facturaId}, Producto: ${nomProd}, Precio: ${precioFinal}, Cantidad: ${cantidad}`
        );

        $.post(
          "createDetailFact.php",
          {
            factId: facturaId,
            nomProd: nomProd,
            precioProd: precioProd,
            precioFinal: precioFinal,
            cantidad: cantidad,
          },
          function (data) {
            let response = JSON.parse(data);
            if (response.success === true) {
              alert("Producto añadido con éxito");
              $("input[name='nomProd']").val("");
              $("input[name='precioProd']").val("");
              $("input[name='cantidad']").val(1);
            } else {
              alert("Error al añadir el producto: " + response.error);
            }
          }
        );
      });

      $("#verFacturasBut").click(function () {
        $("#CreateFactura").addClass("hidden");
        $("#addProduct").addClass("hidden");
        $("#verfacts").removeClass("hidden");
        $("#verfacts").addClass("flex");
        if("#verfactsdetails") $("#verfactsdetails").addClass("hidden");

        $.post("getFacturas.php", {}, function (data) {
          let response = JSON.parse(data);

          $("#verfactsbody").empty();

          if (Array.isArray(response)) {
            response.forEach((factura) => {
              $("#verfactsbody").append(
                `<tr class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
                        <td  class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${factura.id}</td>
                        <td  class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${factura.fecha}</td>
                         <td class="px-6 py-4 text-right">
                    <button class="detalles-btn font-medium text-blue-600 dark:text-blue-500 hover:underline">Detalles <input type="hidden" value="${factura.id}"/></button>

                </td>
                    </tr>`
              );
            });

            $(".detalles-btn").click(function () {
              let id = $(this).find("input").val();
              $("#CreateFactura").addClass("hidden");
              $("#addProduct").addClass("hidden");
              $("#verfacts").addClass("hidden");
              $("#verfactsdetails").removeClass("hidden");
              $("#verfactsdetailsbody").empty();

              $.post(
                "getFacturaDetailById.php",
                { factId: id },
                function (data) {
                  let response = JSON.parse(data);

                  console.log(response);

                  response.details.forEach((factura) => {
                    $("#verfactsdetailsbody")
                      .append(`<tr class="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700">
                        <td  class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${factura.name}</td>
                        <td  class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${factura.price}€</td>
                        <td  class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${factura.quantity}</td>
                        <td  class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white">${factura.priceFinal}€</td>
                        </tr>`);
                    
                  });
                  
                    
                    $("#verfactsdetailsfoot").html(`<tr class="text-xs font-bold text-white uppercase bg-gray-700 ">
                        <td  scope="col" class="px-6 py-3">Total</td>
                        <td scope="col" class="px-6 py-3">
                          <span class="sr-only">ver</span>
                        </td>
                        <td scope="col" class="px-6 py-3">
                          <span class="sr-only">ver</span>
                        </td>
                        <td  scope="col" class="px-6 py-3">${response.total}€</td>
                        </tr>`); 
                }
              );

              //console.log("Hola" + id);
            });
          } else {
            console.log("La respuesta no es un array:", response);
          }
        });
      });
    </script>
  </body>
</html>
